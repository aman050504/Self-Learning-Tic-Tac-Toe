<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .cell {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }
        .cell:hover {
            background-color: #334155; /* slate-700 */
        }
        .cell.x::before, .cell.o::before {
            font-size: 4.5rem;
            line-height: 1;
            font-weight: 700;
            animation: pop-in 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .cell.x::before {
            content: 'X';
            color: #2dd4bf; /* teal-400 */
        }
        .cell.o::before {
            content: 'O';
            color: #fb923c; /* orange-400 */
        }

        @keyframes pop-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .strike-line {
            position: absolute;
            background-color: #f43f5e; /* rose-500 */
            height: 5px;
            border-radius: 9999px;
            transform-origin: 0 50%; /* left center */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scaleX(0); /* Initially hidden by scaling */
        }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen text-white">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
        <h1 class="text-4xl font-bold text-slate-100 mb-2">Play Tic-Tac-Toe</h1>
        <p class="text-slate-400 mb-6">You are 'X' and the AI is 'O'.</p>
        
        <div id="board-container" class="relative">
            <div id="board" class="grid grid-cols-3 gap-3 mb-6">
                <!-- Cells will be generated by JavaScript -->
            </div>
            <div id="strike-line" class="strike-line"></div>
        </div>
        
        <div id="status" class="text-xl font-medium text-slate-300 h-8 mb-4"></div>

        <button id="reset-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out w-full transform hover:scale-105">
            Restart Game
        </button>
    </div>

    <script>
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const resetButton = document.getElementById('reset-btn');
        const strikeLineElement = document.getElementById('strike-line');

        let board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        let userPlayer = 1; // X
        let aiPlayer = 2;   // O
        let currentPlayer = userPlayer;
        let gameActive = true;
        
        const createBoard = () => {
            boardElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell w-24 h-24 bg-slate-700 rounded-lg flex items-center justify-center cursor-pointer text-5xl font-bold';
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardElement.appendChild(cell);
            }
        };

        const handleCellClick = (e) => {
            if (!gameActive || currentPlayer !== userPlayer) return;
            const index = parseInt(e.target.dataset.index);
            if (board[index] === 0) {
                makeMove(index, userPlayer);
                if (gameActive) {
                    currentPlayer = aiPlayer;
                    statusElement.textContent = "AI is thinking...";
                    setTimeout(aiMove, 500);
                }
            }
        };

        const makeMove = (index, player) => {
            if (board[index] !== 0 || !gameActive) return;
            
            board[index] = player;
            updateBoardUI();
            
            const winningInfo = checkWinner(player);
            if (winningInfo) {
                endGame(false, player, winningInfo.condition);
            } else if (board.every(cell => cell !== 0)) {
                endGame(true);
            }
        };
        
        const aiMove = async () => {
            if (!gameActive) return;
            try {
                const response = await fetch('/get_ai_move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ board: board })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const aiMoveIndex = data.move;
                if (aiMoveIndex !== null && board[aiMoveIndex] === 0) {
                    makeMove(aiMoveIndex, aiPlayer);
                }
            } catch (error) {
                console.error("Could not get AI move:", error);
                statusElement.textContent = "Error: Could not connect to AI.";
                gameActive = false;
            }
            if (gameActive) {
                currentPlayer = userPlayer;
                statusElement.textContent = "Your turn";
            }
        };

        const checkWinner = (player) => {
            const winConditions = [
                { c: [0, 1, 2], type: 'h', row: 1 }, { c: [3, 4, 5], type: 'h', row: 2 }, { c: [6, 7, 8], type: 'h', row: 3 },
                { c: [0, 3, 6], type: 'v', col: 1 }, { c: [1, 4, 7], type: 'v', col: 2 }, { c: [2, 5, 8], type: 'v', col: 3 },
                { c: [0, 4, 8], type: 'd', num: 1 }, { c: [2, 4, 6], type: 'd', num: 2 }
            ];
            for (const condition of winConditions) {
                if (condition.c.every(index => board[index] === player)) {
                    return { winner: player, condition: condition };
                }
            }
            return null;
        };

        const endGame = (isDraw, winner = null, winCondition = null) => {
            gameActive = false;
            if (isDraw) {
                statusElement.textContent = "It's a Draw!";
            } else {
                statusElement.textContent = `${winner === userPlayer ? 'You Win!' : 'AI Wins!'}`;
                if (winCondition) {
                    setTimeout(() => drawWinningLine(winCondition), 300);
                }
            }
        };

        const drawWinningLine = (winCondition) => {
            const boardContainerRect = document.getElementById('board-container').getBoundingClientRect();
            const cellElements = boardElement.children;
            
            const startCell = cellElements[winCondition.c[0]];
            const endCell = cellElements[winCondition.c[2]];

            const startRect = startCell.getBoundingClientRect();
            const endRect = endCell.getBoundingClientRect();

            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;

            const lineTop = startY - boardContainerRect.top;
            const lineLeft = startX - boardContainerRect.left;

            const dx = endX - startX;
            const dy = endY - startY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);

            const line = strikeLineElement;
            
            line.style.width = `${length}px`;
            line.style.top = `${lineTop - 2.5}px`;
            line.style.left = `${lineLeft}px`;
            
            line.style.transform = `rotate(${angle}deg) scaleX(1)`;
        };

        const updateBoardUI = () => {
            for (let i = 0; i < 9; i++) {
                const cell = boardElement.children[i];
                cell.classList.remove('x', 'o');
                if (board[i] === userPlayer) {
                    cell.classList.add('x');
                } else if (board[i] === aiPlayer) {
                    cell.classList.add('o');
                }
            }
        };

        const resetGame = () => {
            board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
            currentPlayer = userPlayer;
            gameActive = true;
            statusElement.textContent = "Your turn";
            strikeLineElement.style.transform = 'rotate(0deg) scaleX(0)';
            updateBoardUI();
        };

        createBoard();
        resetButton.addEventListener('click', resetGame);
        statusElement.textContent = "Your turn";
    </script>
</body>
</html>